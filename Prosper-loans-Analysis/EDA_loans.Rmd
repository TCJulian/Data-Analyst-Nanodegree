# Exploratory Data Analysis: Prosper Loan Dataset
_by Tyler Julian_
_Last Updated: 4/05/2018_

========================================================

## Abstract

In the finance, everyone is looking at getting the best deal. Best interest rate, best return, low risk and high reward... as both borrowers and lenders, we want it all. This primarily takes form in the interest rate of a loan. Unfortunately, the interest rate that borrowers want and what lenders want do not always line up. Even worse is trying to understand the factors that determine the interest rate to begin with. For borrowers, credit score is considered the most popular variable, but what other factors impact the loans? The amount of the loan? Where you live? How much income you have? This project hopes to explore some of these trends in a real-life dataset and reveal the biggest factors that influence a borrower's interest rate.

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(memisc)
library(RColorBrewer)
library(tidyr)
```

```{r echo=FALSE, Load_the_Data}
# link to dataset reference: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0

loans <- read.csv('prosperLoanData.csv')
```

## Data Source

This dataset contains loan data from [_Prosper_](https://www.prosper.com/personal-loans/better-finances/?refac=GoogSearch&refmc=BorGenAcq&refd=cm:SEM-Brand%7C%7Cag:29761763651%7C%7Ckw:prosper%20loans%7C%7Cad:233096998244%7C%7Cdv:c%7C%7Cmt:e%7C%7Cap:1t1&gclid=EAIaIQobChMI9_O45P3z2AIV2AuBCh1i3QacEAAYASAAEgItg_D_BwE&flags=BetterFinancesLandingPage:WithoutLoanAmount), an online marketplace that brings investors and borrowers together to fund small to medium sized loans. Borrowers can get loans up to $35,000, with the interest rates set by _Prosper_. Lenders get to choose what loans they want to fund, with higher risk loans providing a higher return.

The dataset can be downloaded from this project's [GitHub repository](https://github.com/TCJulian/Data-Analyst-Nanodegree/tree/master/Prosper-loans-Analysis).

## Initial Exploration

A logical start to understanding this dataset would be to look at its shape and variables.

```{r, echo=FALSE, Shape_loans}
dim(loans)
```

The dataset contains 113,937 observations from 81 different variables.

Let's look at a sample of those variables:

```{r, echo=FALSE, Variables_loans}
head(colnames(loans), 10)
```

There are a multitude variables in this dataset, some of whose meaning may not be intuitive at first glance. This [reference](https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0), adapted from the _Prosper_ API, provides context to each of the variables. 

## Univariate Exploration

### Borrower Interest Rate

One of most important variables for both a borrower and a lender is the interest rate of the loan. The interest rate is ultimately set by _Prosper_ and is determined by a variety of variables. This is the variable of most interest in this exploration.

```{r echo=FALSE, BorrowerRate_Histogram}
ggplot(loans, 
       aes(x = BorrowerRate)) + 
  geom_histogram(binwidth = .01, 
                 fill = "#598BF7", 
                 color = "black") +
  labs(x = "Interest Rate", 
       y = "Count",
       title = "Interest Rate")
```

```{r echo=FALSE, BorrowerRate_sum}
summary(loans$BorrowerRate)
```

The interest rate curve seems to be slightly right skewed, with most values falling between 14% and 25%. There is an abnormal spike  of interest rates occuring at 32%. This could be because of overlapping binwidths. Let's graph interest rate again, but with smaller binwidths to investigate:

```{r echo=FALSE, BorrowerRate_Investigate}

ggplot(loans, 
       aes(x = BorrowerRate)) + 
  geom_histogram(binwidth = 0.005, 
                 fill = "#598BF7", 
                 color = "black") +
  labs(x = "Interest Rate", 
       y = "Count", 
       title = "Interest Rate (bw = 0.5)")
```

Unfortunately, it seems binwidth is not the answer. 32% still has an extremely high appearance count. At the moment, there appears to be no answer as to why this rate occurs so frequently. One option would be to explore a subset of the dataset that only had 32% interest rate users and compare them with the entire population for differences. However, that is beyond the scope of this analysis, as there are other variables to explore.

### Average Credit Score

As one of the most well known indicators of an individual's financial credibility, Credit Score is the most basic requirement for getting a loan. 

This dataset does not provide a singular credit score, but rather a range. The two variables, `CreditScoreRangeLower` and `CreditScoreRangeUpper`, store the upper and lower bounds of a user's credit score. To visualize the data properly, the two ranges need to be combined into an average. The newly created variable will be named `CreditScoreAverage`.

```{r, warning=FALSE, echo=FALSE, Create_CreditScoreAverage}
# Create average credit score column in dataset
loans <- mutate(loans, 
                CreditScoreAverage = round((CreditScoreRangeLower + 
                                            CreditScoreRangeUpper) / 2))
summary(loans$CreditScoreAverage)
```

With a mean of 695.6 and a median of 690, the central tendency of the distribution seems to be consistent. There are 591 NA's in the data and the 1st and 3rd quartiles are within expectations. However, the minimum value seems way off the charts in terms of its distance from the rest of the data. The value itself also doesn't make sense, as the lowest a FICO credit score can be is 400. Let's plot the data to get a better understanding of variable's distribution.

```{r, echo=FALSE, message=FALSE, AvgCreditScore_Histogram}
ggplot(data = subset(loans, !is.na(loans$CreditScoreAverage)), 
       aes(x = CreditScoreAverage)) +
  geom_histogram(fill = "#598BF7", 
                 color = "black") +
  labs(x = "Average Credit Score", 
       y = "Count",
       title = "Average Credit Score")
```

There seems to be a handful of credit scores close to zero. Because these scores are abysmally low and are no where near the rest of the distribution, they are marked as outliers. With this new knowledge, the data is plotted again with smaller binwidths, better breaks, and without the outliers.

```{r echo=FALSE, warning=FALSE, AvgCreditScore_Outliers}
ggplot(data = subset(loans, !is.na(loans$CreditScoreAverage)), 
       aes(x = CreditScoreAverage)) +
  geom_histogram(binwidth = 20, 
                 fill = "#598BF7", 
                 color = "black") +
  scale_x_continuous(limits = c(440, 900), 
                     breaks = c(seq(440, 900, 40))) +
  labs(x = "Average Credit Score", 
       y = "Count",
       title = "Average Credit Score")
```

After those adjustments, the data now has a semi-bell curve. From 680 to 900, the shape of the plot is almost perfect in terms of being normal. From 440 to 680, it has more deviation, but still follows a normal shape.

This plot follows the initial intuition about credit score. It makes sense that most people fall right in the middle of the ranges, with a majority of the scores floating around the average score of 700. You have a smaller subset of people that maybe haven't been up to date on payments or have defaulted, leading to very poor scores. There is also another subset of people who are maybe very diligent about their payments, resulting in high scores. 

### Income

Many lenders also look at a borrower's income when determining the risk associated with a borrower. The intuition is that a borrower with more disposable income should be more likely to pay their monthly payments on a loan. This makes them a less risky investment. 

Income for borrowers is stored in the variable `IncomeRange`:

```{r, echo=FALSE, IncomeRange_str}
str(loans$IncomeRange)
```

`str(IncomeRange)` shows that income is factored into levels:

```{r, echo=FALSE, IncomeRange_levels}
levels(loans$IncomeRange)
```

Two things to note:

1. The levels are not ordered.
2. Some of the levels can be combined.  
  
For this analysis, the values need to be be ordered from least to greatest. This will provide a much more organized plot and move the data type from nominal to ordinal. The levels `Not employed` and `$0`, while still technically having different meanings, both represent that the buyer does not have a primary career that provides income. As a result, these two levels be combined to reduce the complexity of the variable.
  
```{r, echo=FALSE, Income_relevel}
# Order levels
loans$IncomeRange <- factor(loans$IncomeRange, 
                            levels = c("Not displayed", "Not employed", 
                                       "$0", "$1-24,999", 
                                       "$25,000-49,999", "$50,000-74,999", 
                                       "$75,000-99,999", "$100,000+"),
                            ordered = TRUE)

# Combine "Not employed" with "$0" 
levels(loans$IncomeRange) <- c("Not displayed", "$0", 
                               "$0", "$1-24,999", 
                               "$25,000-49,999", "$50,000-74,999", 
                               "$75,000-99,999", "$100,000+")

# Return new levels
levels(loans$IncomeRange)
```

Now that the levels have been properly transformed, the non-NA data can be visualized as a barchart:

```{r, echo=FALSE, Income_Bar}
ggplot(data = subset(loans, loans$IncomeRange != "Not displayed"),
       aes(x = IncomeRange)) +
  geom_bar(fill = "#598BF7",
           color = "black") +
  labs(x = "Income Range ($)",
       y = "Count", 
       title = "Income Ranges of Borrowers")
```

```{r, echo=FALSE, Income_table}
table(loans$IncomeRange)
```

The chart shows that most borrowers have income that falls within two bins: `$25,000-49,999` and `$50,000-74,999`. There are more borrowers that fall above these ranges than below them. This might suggest that borrowers with higher reported incomes are more likely to take out a loan than those with lower reported incomes. 

### Stated Monthly Income

Monthly income is very similar to income range. The biggest and most important difference is that this variable is quantitative rather than qualitative.

```{r, echo=FALSE, Monthly_Income_summary}
summary(loans$StatedMonthlyIncome)
```
There is a very large outlier in dataset with one individual claiming to bring in almost 2 million dollars every month. The top 1% of the data will be removed so the distribution can be more clearly viewed.

```{r, echo=FALSE, warning=FALSE, Monthly_Income_plot}
ggplot(data = loans,
       aes(x = StatedMonthlyIncome)) +
  geom_histogram(fill = "#598BF7",
                 color = "black", 
                 binwidth = 500) +
  lims(x = c(0, quantile(loans$StatedMonthlyIncome, prob=(.99)))) +
  labs(x = "Monthly Income ($)",
       y = "Count", 
       title = "Monthly Income of Borrowers")
```

The distribution is skewed right with most individuals making about $4,750, or about \$57,000 a year. This follows very closely to with the results from the `IncomeRange` variable. A majority of borrowers make less than \$7,500 a month, while there are some borrowers that make much more.

### Debt to Income Ratio

Debt to income ratio is exactly what it sounds like: a borrower's debt divided by their current income at the time the credit profile was pulled. A higher debt to income ratio might sugggest that an individual is a riskier investment, since they are already burdened with more debt compared to their income.

```{r, echo=FALSE, DebtIncomeSummary}
summary(loans$DebtToIncomeRatio)
```

A quick look at the summary of the variable shows that the median ratio is 0.22, while the mean is a bit higher at 0.276. The maximum is incredibly high, showing a debt to income ratio of over 1000%. A quick look at the variable reference page shows that any ratios higher than 10.01 are rounded to that number.

In order to deal with these potential outliers, the top 1% of values are excluded from the resulting plot:

```{r echo=FALSE, warning=FALSE, DebtIncome_Histogram}
ggplot(loans, aes(x = DebtToIncomeRatio)) +
  geom_histogram(binwidth = 0.025, 
                 fill = "#598BF7", 
                 color = "black") +
  scale_y_continuous(breaks = c(seq(0, 11000, 1000))) +
  scale_x_continuous(breaks = c(seq(0, 1, 0.1)), 
                     limits = c(0, quantile(loans$DebtToIncomeRatio, 
                                            probs = 0.99, 
                                            na.rm = TRUE))) +
  labs(x = "Debt/Income Ratio", 
       y = "Count", 
       title = "Debt to Income Ratio")
  
```

The distribution of debt to income seems to be slightly right skewed with a long tail. There are small peaks at all of the 0.5 breaks, which might suggest that the data was rounded upon retrieval. The right skew would explain the higher mean than the median. It makes intuitive sense that the majority of individuals have a low debt to income ratio on average, with the count decreasing as the debt to income ratio climbs higher. It becomes increasingly difficult for an individual to pay their expenses as the debt to income ratio increases due to interest accrued on the debt.

### Term Length

Term length is the length of time the loan has until it has to be paid off. A longer term length means the borrowers have to pay less per month, but perhaps more interest over the life of the loan.

```{r echo=FALSE, TermLength_Unique}
unique(loans$Term)
```

Looking at only the unique values of `Term`, the only terms offered by _Prosper_ are 12, 36, and 60 term lengths. The API shows that this variable is measured in months. 

The `Term` variable currently has no levels, but can be easily factored since there are so few unique values.

```{r, echo=FALSE, TermLength_Factored}
loans$Term <- factor(loans$Term, levels = c(12, 36, 60), ordered = TRUE)
```

```{r echo=FALSE, TermLength_Bar}
ggplot(data = loans, aes(x = Term)) +
  geom_bar(fill = "#598BF7", 
           color = "black") +
  labs(x = "Term Length (months)", 
       y = "Count", 
       title = "Term Length")
```

```{r, echo=FALSE, TermLength_Table}
table(loans$Term)
```

It appears that the vast majority of loans have a term length of 36, accounting for 77% of all loans. Term lengths of 60 make up most of the remaining loans, with 12 month terms only accounting for 1.4% of all loans.

### Estimated Return

For lenders, how much return they receive from their investment is a very important factor when choosing which loans to fund. _Prosper_ has a variable for this value, `EstimatedReturn`, displayed as a percentage. This variable is calculated by taking the difference from a loan's `EstimatedEffectiveReturn` and `EstimatedLoss`. Both of these variables can be found in detail from the variable [reference page](https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0).

```{r, echo=FALSE, EstimatedReturn_Summary}
summary(loans$EstimatedReturn)
```

A summary shows that the average expected return is around 9.5%. This is slightly higher than [6.7% average total return](https://www.prosper.com/invest) listed on their website. There are also a lot of NAs for this particular variable, probably attributable to the fact that this variable wasn't being tracked until the start of July 2009.

```{r, echo=FALSE, warning=FALSE, EstimatedReturn_Histogram}

ggplot(loans, aes(x = EstimatedReturn)) +
  geom_histogram(binwidth = .01, 
                 fill = "#598BF7", 
                 color = "black") +
  scale_x_continuous(limits = c(-.1, .3), 
                     breaks = c(seq(-.1, .3, .05))) +
  labs(x = "Estimated Return", 
       y = "Count)", 
       title = "Estimated Return")
```

The distribution appears to be approximately normally distributed. However, some of the values seem to have very high counts, which makes it much harder to see the data in the tails. By scaling the y-axis by square roots, the tails should be easier to see.

```{r echo=FALSE, warning=FALSE, EstimatedReturn_yscaled}
ggplot(loans, aes(x = EstimatedReturn * 100)) +
  geom_histogram(binwidth = 1, 
                 fill = "#598BF7", 
                 color = "black") +
  scale_x_continuous(limits = c(-10, 30), 
                     breaks = c(seq(-10, 30, 5))) +
  scale_y_sqrt(breaks = c(100, 1000, 2500, 5000, 10000, 12000)) +
  labs(x = "Estimated Return (%)", 
       y = "sqrt(Count)", 
       title = "Estimated Return Histogram")
```

Now the tails are much easier to see. The distribution does indeed remain approximately normally distributed, with the peak right around the mean and median. Most of the estimated returns are positive. 

```{r, echo=FALSE, EstimatedReturn_positive }
length(loans$EstimatedReturn[loans$EstimatedReturn > 0]) / length(loans$EstimatedReturn)
```

In fact, over 99% of all loans through _Prosper_ have a positive estimated return. From a lender standpoint, this is excellent news. However, I doubt that these estimations live up to reality. This variable is more theoretical and makes assumptions about the actions of the borrower. It assumes that the borrower makes all of their payments and does not default on the loan, which I don't think the data will support. Further investigation into the result of loans is required.

### Borrower State

`BorrowerState` is exactly what it sounds like: the state the borrower currently resides in when acquiring the loan.

```{r, echo=FALSE, BorrowerState_str}
str(loans$BorrowerState)
```

The structure of the variable shows that each state is treated as its own level. 

```{r echo=FALSE, BorrowerState_Bar, fig.width = 12, fig.height=4}
ggplot(subset(loans, loans$BorrowerState != ''), (aes(x = BorrowerState))) +
  geom_bar()
```

Quickly plotting the variable shows that the levels need to be reordered if they are going to be visualised in a bar chart. This data will be reordered from highest count to lowest count.

```{r, echo=FALSE, BorrowerState_Order}
loans$BorrowerState <- factor(loans$BorrowerState, level = names(sort(table(loans$BorrowerState), decreasing = TRUE)))
```

```{r echo=FALSE, BorrowerState_OrderedBar, fig.width = 12, fig.height=4}
ggplot(data = subset(loans, loans$BorrowerState != ''), 
       (aes(x = BorrowerState))) +
  geom_bar(fill = "#598BF7", 
           color = "black") +
  labs(x = "States", 
       y = "Count", 
       title = "Borrowers by State")
```

California appears to have much more borrowers than any other state. This is understandable sense [_Prosper_ was founded in San Francisco California](https://www.prosper.com/plp/about/contact-us/). The states following California--Texas, New York, Florida--are also metro hubs with large tech industries. Individuals who are more technologically inclined might be more willing to take out a loan online.

### Credit Grade and Prosper Rating

In an effort to make investments easier to assess for potential investors, _Prosper_ created the "CreditGrade" scoring system. This was eventually replaced with the "Prosper Rating" system in 2009, which is very similiar to CreditGrade. In order to analyze these variables throughout all of the data, the two rating systems need to be combined into one. 

```{r, echo=FALSE, Rating_levels}
levels(loans$CreditGrade)
levels(loans$ProsperRating..Alpha.)
```
 
Looking at the levels of the two variables, Credit Grade has an extra level called `NC`. The rest of both levels are the same. It is also important to note that the variables have no `NA` values. Rather, they are input as "". 

In order to manipulate these variables effectively, the "" values need to be substituted with `NA`. Once the "" values transformed into NA's, `ProsperRatings` and `CreditGrade` can be combined into a single column and ordered from the lowest ratings to the highest rating.
 
```{r, echo=FALSE, Rating_combine}
# Remove NAs from CreditGrade and ProsperRating
loans$ProsperRating..Alpha.[loans$ProsperRating..Alpha. == ""] <- NA
loans$CreditGrade[loans$CreditGrade == ""] <- NA

# Combining Credit Grade and Prosper Rating into loans$ratings
loans$ratings <- loans$CreditGrade
loans$ratings[!is.na(loans$ProsperRating..Alpha.)] <- loans$ProsperRating..Alpha.[!is.na(loans$ProsperRating..Alpha.)]

loans$ratings <- factor(loans$ratings, 
                        levels = c('NC', 'HR', 'E', 'D', 'C', 'B', 'A', 'AA'))
```

```{r, echo=FALSE, Ratings_Bar}
ggplot(subset(loans, !is.na(loans$ratings) & loans$ratings != "NC"), 
       aes(x = ratings)) +
  geom_bar(fill = "#598BF7",
           color = "black") +
  labs(x = "Credit Rating", 
       y = "Count", 
       title = "Credit Rating Bar Chart")
```

```{r, echo=FALSE, Rating_summary }
summary(subset(loans$ratings, !is.na(loans$ratings)))
```

The plot for the combined rating systems turns out very well. The data appears normally distributed with the `C` rating having the most values. The highest rating, `AA`, has the least amount of values.

### Prosper Score

A borrower's _Prosper_ Score is an internal measurement used by _Prosper_ to measure the risk of a borrower. The higher the score, the lower the risk of the borrower to lenders.

```{r, echo=FALSE, ProsperScore_str}
str(loans$ProsperScore)
summary(loans$ProsperScore)
```

It appears that there are quite a few "NA's" in this variable. There is also some values above ten. The _Prosper_ API doesn't provide any insight into the values; on the contrary, values should only go up to ten. As a result, NA's and values greater than 10 will be left out of the resulting plot.

```{r, echo=FALSE, warning=FALSE, ProsperScore_hist}
ggplot(data = subset(loans, !is.na(loans$ProsperScore)),
       aes(x = ProsperScore)) +
  geom_histogram(binwidth = 1,
                 fill = "#598BF7",
                 color = "black") +
  scale_x_continuous(limits = c(0, 11),
                     breaks = c(seq(1, 10, 1))) +
  labs(x = "Prosper Score",
       y = "Count", 
       title = "Prosper Score")
```

```{r, echo=FALSE, ProsperScore_table}
summary(subset(loans$ProsperScore, loans$ProsperScore != 11))
table(subset(loans$ProsperScore, loans$ProsperScore != 11))
```

The `ProsperScore` distribution appears normally distributed. This distribution appears similar to the combined rating system that was explored previously. Most values fall in the middle, between 4 and 8, with the median value at 6. The tails on either end of the distribution have much lower values.

### Loan Status

Each loan has a loan status associated with it. This determines whether the current loan has been completed, whether it is late on its payments, or whether it has been defaulted on.

```{r echo=FALSE, LoanStatus_Levels}
levels(loans$LoanStatus)
```

Currently, there is a lot of detail in the levels. However, the granularity of the data can be reduced by combining some of the levels. More specifically, some of the `Past Due` bins can be combined. `FinalPaymentInProgress` loans can also be lumped with `Current` loans.

Once the categorical bins have been combined, the levels can also be ordered from the most favorable status to the least favorable status.

```{r echo=FALSE, LoanStatus_Relevel}
# Combine "Past Due" levels
levels(loans$LoanStatus) <- c("Cancelled", "Chargedoff", "Completed", "Current",
                              "Defaulted", "Current", 
                              "PastDue (>30 days)", "PastDue (1-30 days)", 
                              "PastDue (1-30 days)", "PastDue (>30 days)", 
                              "PastDue (>30 days)", "PastDue (>30 days)")
# Order levels
loans$LoanStatus <- factor(loans$LoanStatus, 
                            levels = c("Completed", "Current", 
                                       "PastDue (1-30 days)", 
                                       "PastDue (>30 days)", 
                                       "Defaulted", 
                                       "Chargedoff", 
                                       "Cancelled"))
```

```{r echo=FALSE, LoanStatus_Histogram, fig.width=8}
ggplot(data = subset(loans, loans$LoanStatus != 'Cancelled'), 
       aes(x = LoanStatus)) +
  geom_bar(fill = "#598BF7",
           color = "black") +
  labs(x = "Status", 
       y = "Count", 
       title = "Loan Status Histogram")
```

```{r echo=FALSE, LoanStatus_Table}
table(loans$LoanStatus)
```

A vast majority of the loans are either completed or active with up-to-date payments. However, there is also a large minority of loans that either go into default or are chargedoff. These negative results account for approximately 15% of all loans from _Prosper_. Recalling the results from the `EstimatedReturn` distribution, it is clear that not all investments result in a positive return. Lenders that invested in loans that were either defaulted on or chargedoff probably made a net loss. 

### Loan Amount

Loan amount is the total amount of cash given to the borrower once the loan is approved. Loans start at \$1,000 and go up to a maximum of \$35,000.

```{r echo=FALSE, LoanAmount_Histogram}
ggplot(data = loans, aes(x = LoanOriginalAmount)) +
  geom_histogram(binwidth = 1000,
                 fill = "#598BF7",
                 color = "black") +
  scale_x_continuous(breaks = c(seq(0, 35000, 5000))) +
  labs(x = "Loan Amount ($)",
       y = "Count",
       title = "Loan Amount")
```

```{r echo=FALSE, LoanAmount_summary}
summary(loans$LoanOriginalAmount)
```

The distribution is right skewed with multi-modal peaks. These peaks are all at the \$5,000 increments, which is probably attributable to the fact most people get loans at even amounts. 75% of the loans are $12,000 or less, with only a handful of loans at the maximum amount of \$35,000.

### Employment Status

A common metric requested from lenders is the borrower's current employment status. Employment status gives the lender a gauge on the potential cashflow the borrower currently has. More cashflow usually represents a safer loan.

```{r, echo=FALSE, EmploymentStatus_levels}
levels(loans$EmploymentStatus)
```

Currently, the levels are not ordered and are listed nominally. `Not available` and `""` basically represent the same idea and can be combined.

To better analyse the variable, the levels will be ppoperly ordered and the two levels mentioned earlier will be removed from the plot.

```{r echo=FALSE, EmploymentStatus_relevel}
# Combine "" and "Not available"
levels(loans$EmploymentStatus) <- c("Not available", "Employed", "Full-time", 
                                    "Not available", "Not employed", "Other", 
                                    "Part-time", "Retired", "Self-employed")

# Order levels
loans$EmploymentStatus <- factor(loans$EmploymentStatus, 
                                 levels = c("Employed", "Full-time", 
                                            "Part-time", "Self-employed",
                                            "Retired", "Not employed",
                                            "Other", "Not available"))
```

```{r echo=FALSE, EmploymentStatus_Bar}
ggplot(data = subset(loans, loans$EmploymentStatus != "Not available"),
       aes(x = EmploymentStatus)) +
  geom_bar(fill = "#598BF7",
           color = "black") +
  labs(x = "Employment Status",
      y = "Count",
      title = "Employment Status")
```

It appears that most borrowers are employed in some manner. Very few report being unemployed, retired, or part-time. I imagine most borrowers just report being "Employed" and leave out the details of their type of employment.

### Employment Duration

Along with employment status, lenders also consider the borrower's employment duration. Longer durations usually signify more stable income, and thus a safer investment.

```{r, echo=FALSE, EmploymentStatusDuration_summary}
summary(loans$EmploymentStatusDuration)
```

The summary of the variable, as well as the _Prosper_ API, confirm that `EmploymentStatusDuration` is measured in months. The variable will be viewed in years for the following plots, as years are much easier to visualize and understand.

```{r echo=FALSE, EmploymentStatusDuration1}
ggplot(data = subset(loans, !is.na(loans$EmploymentStatusDuration)), 
       aes(x = EmploymentStatusDuration / 12)) +
  geom_histogram(binwidth = 1,
                 fill = "#598BF7",
                 color = "black") +
  scale_x_continuous(breaks = c(seq(0, 65, 5))) +
  labs(x = "Number of Years Employed",
       y = "Count", 
       title = "Employment Duration Histogram")
```
```{r echo=FALSE, EmploymentStatusDuration2}
summary(loans$EmploymentStatusDuration / 12)
```

The initial plot shows that the data is right skewed and unimodal. There is a long tail with some values way beyond the 3rd quartile. 50% of borrowers have employment durations between two and five 1/2 years. Approximately 80% of borrwers have at least one year of employment duration.

### Summary of Univariate Analysis

The dataset consists of 83 variables with 113,937 observations.

__The variables of interest in this analysis are:__

  1. Interest Rate
  2. Average Credit Score
  3. Income range
  4. Monthly Income
  5. Debt/Income Ratio
  6. Term Length
  7. Estimated Return
  8. Borrower State
  9. Borrower Rating
  10. Prosper Score
  11. Loan Status
  12. Loan Amount
  13. Employment Status
  14. Employment Duration
  
__Some of the more important observations:__

 * The interest rate distribution was slightly right skewed, with the average rate being ~19%.
 * The average credit score was 690.
 * The loan amount distribution was multimodal with most loans being less than or equal to $15,000.
 * Most loans had terms of 32 months.
 * Borrower ratings and Prosper Score were normally distributed, with most loans having moderate risk.
 * The average borrower was employed for 5.5 years and made between $50,000 and $75,000.
  
The main feature of interest in this dataset is the borrower's interest rate. The goal is to make a model that can predict the interest rate of Prosper loan, given some list of variables.

There are several variables that could potentially predict the interest rate a borrower has. Obviously `Credit Score` will be used, as it is one of the more well known predictors for interest rate. `Income`, `Loan Amount`, `Employment Duration/Status`, and `Debt/Income Ratio` all might be correlated with interest rate as well, and will definitely appear in the bivariate analysis. `Rating` and `Prosper Score` are other interesting variables to explore, especially with some of the other supporting variables.

In this analysis, there were several variables that were adapted so they could be properly used. `Income`, `Term Length`, `Loan Status`, `Borrower State`, and `Employment Status` all had their levels added, combined, or reordered. One new variable, `Rating`, was recreated entirely using the two other rating systems implemented by _Prosper_. This rating give a score to each borrower in the dataset that determines their riskiness and return for lenders.

From the univariate exploration, there were a few unusual observations. The interest rate distribution had an unusually high occurence count at 32%. This could be due to rounding, or is a specific point that _Prosper_'s interest rate algorithms arrive at. There were also some values outside of the range of credit scores. This could be due to those borrowers having no credit. 

## Bivariate Exploration

### Interest Rate vs. Credit Score

A borrower's credit score is widely known as being the biggest factor in determining the interest rate of a loan. Considering that,  it will be the first variable paired with interest rate.

```{r echo=FALSE, warning=FALSE, AvgCreditScore_BorrowerRate_jitter}
ggplot(loans, aes(x = CreditScoreAverage, y = BorrowerRate)) +
  geom_point(alpha = 0.02,
             position = position_jitter(w = 8)) +
  scale_x_continuous(limits = c(400, 900), breaks = c(seq(400, 900, 50))) +
  ylim(0, 0.4) +
  labs(x = 'Average Credit Score', 
       y = 'Interest Rate',
       title = "Interest Rate by Average Credit Score")
```

The initial plot shows that there may be a correlation between interest rate and credit score. There appears to be a slight downward trend in th data. As credit score increases, the interest rate seems to decrease. This is the relationship that was expected.

```{r, echo=FALSE, CreditScore_BorrowerRate_cor}
cor(loans$CreditScoreAverage, loans$BorrowerRate, use = "complete.obs")
```

A short correlation test supports this theory. The test shows that there is a moderate negative correlation between credit score and interest rate. 

```{r, echo=FALSE, CreditScore_BorrowerRate_lm}
summary(lm(BorrowerRate ~ CreditScoreAverage, data=loans))
```

Fitting this distribution to a linear model shows that there is indeed some sort of relationship. While there is a correlation between credit score and interest rate, it only explains 21.3% of the variance in interest rate according to the R^2 score.

With this first variable, the underlaying factors that may predict the interest rate of a loan are coming to the surface. However, credit score was an obvious first choice. What other variables in tandem with credit score might provide us with a stronger predictive model?

### Interest Rate vs. Loan Amount

One intuition might be that the size of the loan might impact the interest rate. As the size of the loan goes up, lenders might require that the borrowers are more trust worthy and less risky compared to a small sized loan.

```{r echo=FALSE, LoanAmount_BorrowerRate_jitter}
ggplot(loans, aes(x = LoanOriginalAmount, y = BorrowerRate)) +
  geom_point(alpha = 0.10, 
             size = 0.6,
             position = position_jitter(width = 100)) +
  scale_x_continuous(breaks = c(seq(0, 35000, 5000))) +
  labs(x = "Loan Amount ($)", 
       y = "Interest Rate", 
       title = "Interest rate by Loan Amount")
```

Overall, there appears to be a slight downward trend in the data. At the amount of the loan increases, the interest rate decreases. The dark bands represent the multi-model peaks loan amount histogram, where borrowers request loans at similiar, even amounts.

```{r, echo=FALSE, LoanAmount_BorrowerRate_cor}
cor(loans$LoanOriginalAmount, loans$BorrowerRate, use = "complete.obs")
```

```{r, echo=FALSE, InterestRate_LoanAmount_lm}
summary(lm(BorrowerRate ~ LoanOriginalAmount, data=loans))
```

The scatterplot and the correlation test both support the relationship between loans amount and interest rate. The small negative correlation means that as the size of the loan increases, the interest rate on average decreases a little as well. 
 
Unfortunately, casting a linear model on this variable does not yield the best results. The relationship is not strong enough, and thus only accounts for 7% of the variation in interest rates.
 
### Interest Rate vs. Rating

The rating of a loan is the snapshot of a borrowers riskiness at _Prosper_. I suspect that there might be a relationship between the rating of a loan and its interest rate, considering that the rating system is used to determine the risk and return of a loan.

```{r echo=FALSE, Rating_BorrowerRate}
ggplot(subset(loans, !is.na(loans$ratings) & loans$ratings != "NC"), 
       aes(x = ratings, y = BorrowerRate)) + 
  geom_boxplot() +
  labs(x = "Ratings",
       y = "Interest Rate",
       title = "Interest Rate by Ratings")
```

```{r, echo=FALSE, InterestRate_Ratings_sum}
summary(lm(BorrowerRate ~ ratings, data=loans))
```

There is clearly a strong relationship between interest rate and ratings; in fact it is the strongest relationship we have seen so far. The difference between the median of the lowest rating and the highest rating is almost 25 percentage points! `Ratings` account for 78% of the variance in interest rate according to the R^2 value.  It could be that rating is tied to other variables that are correlated with interest rate, such as credict score or the amount of the loan. Regardless, this is definitely a variable that could be used to predict the interest rate of a loan.

### Interest Rate vs. Prosper Score

Similar to `Rating`, `_Prosper_ score` is another risk measurement of a borrower. The major difference is that it is used internally. I expect that there will be some sort of relationship between it and interest rate, just like with `Rating`.

```{r echo=FALSE, warning=FALSE, InterestRate_ProsperScore_jitter}
ggplot(subset(loans, loans$ProsperScore != 11),
       aes(x = ProsperScore, y = BorrowerRate)) +
  geom_point(alpha = 0.05, 
             position = position_jitter(h=0)) +
  scale_x_continuous(limits = c(0, 11),
                     breaks = c(seq(1, 10, 1))) +
  labs(x = "Prosper Score",
       y = "Interest Rate",
       title = "Interest Rate by Prosper Score")
```

```{r, echo=FALSE, InterestRate_Prosperscore_cor}
cor(loans$ProsperScore, loans$BorrowerRate, use = "complete.obs")
```

```{r, echo=FALSE, InterestRate_Prosperscore_lm}
summary(lm(BorrowerRate ~ ProsperScore, data=loans))
```
As predicted, there is a moderate negative correlation between interest rate and Prosper score. As the score goes up (or as risk goes down), interest rates tend to decrease as well. Scores near the middle appear to have the most variance in interest rate, with some individuals having rates at 10% on the low side and 35% on the high side. This variable also had a high R^2 value at 42%, making this a good feature for the linear model.

### Interest Rate vs. Income

It would make sense that individuals who have more cash flow are rewarded with lower interest rates. The intuition is higher income results in a better ability to pay off their loan. This means a less risky investment for the lender and lower interst rates for the borrower.

```{r echo=FALSE, InterestRate_Income}
ggplot(data = loans,
       aes(x = IncomeRange, y = BorrowerRate)) +
  geom_boxplot() +
  labs(x = "Income Range ($)",
       y = "Interest Rate",
       title = "Interest Rate by Income Range")
```

```{r echo=FALSE, warning=FALSE, InterestRate_DebtIncomeRatio}
ggplot(data = loans,
       aes(x = StatedMonthlyIncome, y = BorrowerRate)) +
  geom_point(alpha = 0.1, size = 1) +
  lims(x = c(0, quantile(loans$StatedMonthlyIncome, probs=(0.99)))) +
  labs(x = "Monthly Income ($)",
       y = "Interest Rate",
       title = "Interest Rate by Monthly Income")
```

```{r, echo=FALSE, BorrowerRate_MonthlyIncome_corr}
cor(loans$StatedMonthlyIncome, loans$BorrowerRate, use = "complete.obs")
```

Based off both the boxplot and the scatter plot, there does appear to be a relationship between income and interest rate, but it is not very strong. Borrowers with more income do have slightly lower interest rates on average, with each range having a lower median interest rate than the previous. Stated monthly income follows a similar pattern, but further shows how weak the correlation is.  

These findings are surprising. I expected income to be correlated much more highly with interest rate. It is possible that these variables aren't very reliable in determining a borrower's trustworthiness. Income can fluctuate greatly from month to month, and sometimes isn't verifiable. These factors together may make income less a determinant for interest rate and more as a secondary feature to describe the borrower.

### Interest Rate vs. Borrower State

Where someone lives in the United States can usually have a profound impact on someones financials, due to cost of living, taxes, etc. It would make sense that interest rates also fluctuate in the same pattern. 

```{r echo=FALSE, InterestRate_BorrowerState, fig.height=5, fig.width=11}
ggplot(data = subset(loans, BorrowerState != ""),
       aes(x = reorder(BorrowerState,
                       -BorrowerRate, 
                       FUN=median), 
           y = BorrowerRate)) +
  geom_boxplot() +
  geom_hline(yintercept = 0.184, 
             color = "red") + 
  scale_y_continuous(breaks = c(seq(0, 0.4, 0.1)),
                     limits = c(0, 0.4)) +
  labs(x = "Borrower State",
       y = "Interest Rate",
       title = "Interest Rate by Borrower State")
```

This inital plot, sorted by the median interest rate, displays quite the contrary. Interest rates do not seem to differ much between states on average. The horizontal red line is the median interest rate across all states. Overall, there are slight deviations between between states, but they all still lie close to the overall median interest rate. The range between the highest and lowest medians is about 6%. A few of the states that deviate the most are Maine and Iowa on the low side and Alabama and North Dakota on the high side. 

### Interest Rate vs. Employment

Employment history and duration are other important metrics that might have a relationship with interest rate. Borrowers who are currently employed and who have a longer employment duration may be considered to be a safer investment.

```{r echo=FALSE, InterestRate_EmploymentStatus}
ggplot(data = loans,
       aes(x = EmploymentStatus, y = BorrowerRate)) +
  geom_boxplot() +
  labs(x = "Employment Status",
       y = "Interest Rate",
       title = "Interest Rate by Employment Status")
```

For the most part, employment status does not seem to be related to interest rate. There is not much variance between the different employment statuses  with the exception of being not employed. Reporting as "Not employed" seems to be the only response that may be related to a higher interest rate. 

```{r echo=FALSE, warning=FALSE, InterestRate_EmploymentDuration}
ggplot(data = loans,
       aes(x = EmploymentStatusDuration / 12, y = BorrowerRate)) +
  geom_point(alpha = 0.2, size = .5) +
  lims(y = c(0, 0.4)) +
  labs(x = "Employment Duration (years)",
       y = "Interest Rate",
       title = "Interest Rate by Employment Duration")
```

```{r}
cor(loans$BorrowerRate, loans$EmploymentStatusDuration, use = "complete.obs")
```

Unfortunately, there also does not seem to be any correlation between employment duration and interest rate either. The scatter plot shows no discernable trend or pattern. The correlation test returns approximately zero, representing no relationship.

It is surprising to find that employment status and duration don't have much of a relationship with interest rate. The only red flags are when someone reports being unemployed. The difference between working for 6 months and working for 30 years doesn't seem to have much of an impact on the interest rate a borrower would receive for a loan.

### Summary Bivariate Analysis

The bivariate section definitely shed some light into the relationships between interest rate and the other variables in the dataset. 

Interest rate appears to be negatively correlated with several variables in the dataset. There were some variables that had no relationships with interest rate at all. Employment duration and employment status both had no correlation with interest rate. Income had a slight negative correlation, but nothing that might suggest that they are closely related. Surprisingly, interest rates did not fluctate much between different states, even though cost of living is different amongst each of them.

The strongest relationship was between interest rate and the borrower's rating, Prosper Score, and credit score. All of these variables had moderate to strong negative correlations with interest rate. Together, these three variables might provide the foundations of a linear model for predicting interest rate. 

## Multivariate Exploration

### Interest Rate by Rating Density Plot

If borrower ratings and interest rate are truly related, there should be a clear segmentation between the amount of borrowers and their interest rate at each rating.

```{r echo=FALSE, warning=FALSE, BorrowerRate_Rating_density}
ggplot(data = subset(loans, ratings != 'NC' & !is.na(ratings)),
       aes(x = BorrowerRate*100, fill = ratings)) +
  geom_density(size = .5,
               alpha = .8) +
  lims(x = c(0, 40)) +
  scale_fill_brewer(palette = "Greens") +
  guides(fill = guide_legend(reverse=T)) + 
  labs(x = "Interest Rate",
       y = "Density",
       title = "Density Plot of Interest Rate by Rating") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = '#878787'),
        panel.grid.minor = element_line(color = '#878787')) 
```

This density plot visualization really shows how each rating corresponds with a specific range of interest rates. The highest rating "AA" peaks at the low end of the interest rates. The rating under that, "A", peaks at a little higher interest rate. As you move down the tier list, the interest rates peak at higher and higher interest rates, with the high risk ("HR") accounts peaking at the notorious 32% mark.

This clear delineation of the rating further supports the strong relationship between interest rates and ratings.

### Loan Amount  vs. Interest Rate by Rating

Loan amount and interest rate had a slight negative correlation in the bivariate section. Let's explore this variable further, but with ratings in the mix as well. 

```{r echo=FALSE, warning=FALSE, LoanAmount_BorrowerRate_Rating, fig.height=4, fig.width=14}
ggplot(data = subset(loans, ratings != 'NC' & !is.na(ratings)), 
       aes(x = LoanOriginalAmount/1000, y = BorrowerRate, color = ratings)) +
  facet_grid(. ~ ratings) +
  geom_point(alpha = 0.5) +
  scale_x_sqrt(breaks = c(0, 1, 5, 10, 17, 25, 35)) + 
  scale_color_brewer(palette = "RdBu") + 
  labs(x = "Original Loan Amount ($, thousands)", 
       y = "Interest Rate",
       title = "Interest rate vs. Loan Amount by Rating") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey')) 
```

This plot still shows the small correlation between rating and loan amount from the bivariate section. Overall, there is a rightward shift in the distributions of loan amounts as the rating increases. Most of the high risk loans are for smaller loans less than $5,000. The loan amounts above \$25,000 contain almost no high risk accounts and only "B" or higher ratings. The downard trend in the interest rate a the rating increases further demonstrates the strong relationship between ratings and interest rate seen in the previous plot.

### Average Credit Score vs. Interest Rate by Rating

Of all of the variables, credit score, rating, and interest rate are the variables that might be the most closely related. 

```{r, echo=FALSE, warning=FALSE, CreditScore_BorrowerRate_Rating_jitter, fig.height=5, fig.width=10}
ggplot(data = subset(loans, ratings != 'NC' & !is.na(ratings)), 
       aes(x = CreditScoreAverage, y = BorrowerRate, color = ratings)) +
  geom_point(alpha = 0.5,
             position = position_jitter(w = 9)) +
  scale_x_continuous(limits = c(400, 900),
                     breaks = c(seq(400, 900, 50))) + 
  scale_color_brewer(palette = "RdBu") + 
  lims(y = c(0, 0.4)) +
  labs(x = "Credit Score", 
       y = "Interest Rate",
       title = "Interest Rate vs.Credit Score by Rating") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey')) 
```

I believe that this plot perfectly captures the relationship between interest rate, credit score, and ratings. There is a clear separation between the ratings are the credit score increases. The lower, less risk accounts with high credit scores get the best ratings by _Propser_, and thus the lowest interest rates. As the credit score decreases, the average interest rate increases and the ratings begin to change. There is a nice progression of the ratings as both the interest rate increases and the credit score decreases.

Something very peculiar is the band of "HR" borrowers that persist across the top of the distribution as the credit score increases. They all appear to be around, you guessed it, 32%. There must be a specfic scenario where a borrower has a decent credit score, but is still classified as a high risk investment. This phenomenon may be the subject of further study in the future.

With the major relationships explored, a linear model model can be built for predicting interest rate.

```{r, echo=FALSE, mtable}
m1 = lm(formula = BorrowerRate ~ ratings, data = loans)
m2 = lm(formula = BorrowerRate ~ ratings + ProsperScore, data = loans)
m3 = lm(formula = BorrowerRate ~ ratings + ProsperScore + CreditScoreAverage,
        data = loans)
m4 = lm(formula = BorrowerRate ~ ratings + ProsperScore + CreditScoreAverage +
        LoanOriginalAmount, data = loans)
mtable(m1, m2, m3)
```

Ultimately, the model can account for 91.5% of the variance in the interest rate of a loan. This is a solid start for the model, considering it only uses 3 features.

### Summary of Multivariate Analysis

The multivariate analysis further supported the relationships between interest rate and the other variables in the dataset. `Rating` continued to show a strong connection with interest rates across both loan amounts and credit score. The density plot of ratings by interest rate further supported the clear segmentation of ratings by interest rate.

The linear model that was built to predict interest rate can account for 91.5% of the varince in interest rate. It was built using the `Ratings`, `Prosper Score`, and `Credit Score` variables.

## Conclusion / Final Plots

### Relationship between Interest Rate and Rating

```{r echo=FALSE, warning=FALSE, BorrowerRate_Rating_density_final}
ggplot(data = subset(loans, ratings != 'NC' & !is.na(ratings)),
       aes(x = BorrowerRate*100, fill = ratings)) +
  geom_density(size = .5,
               alpha = .8) +
  lims(x = c(0, 40)) +
  scale_fill_brewer(palette = "Greens") +
  guides(fill = guide_legend(reverse=T)) + 
  labs(x = "Interest Rate",
       y = "Density",
       title = "Density Plot of Interest Rate by Rating") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = '#878787'),
        panel.grid.minor = element_line(color = '#878787')) 
```

#### Description

Ratings are clearly segmented by interest rates. Low risk borrowers have higher occurences at low interest rates. As the risk level of the rating increases, borrower frequency peaks at higher and higher interest rates.  

### Interest Rates Across US States

```{r echo=FALSE, InterestRate_BorrowerState_final, fig.height=5, fig.width=11}
ggplot(data = subset(loans, BorrowerState != ""),
       aes(x = reorder(BorrowerState, 
                       -BorrowerRate, 
                       FUN=median), 
           y = BorrowerRate)) +
  geom_boxplot(fill = "#666DFF") +
  geom_hline(yintercept = 0.184,
             size = .75,
             linetype = 1,
             color = "#D50000") + 
  scale_y_continuous(breaks = c(seq(0, 0.4, 0.1)),
                     limits = c(0, 0.4)) +
  labs(x = "Borrower State",
       y = "Interest Rate",
       title = "Interest Rate by Borrower State") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = '#878787'),
        panel.grid.minor = element_line(color = '#878787')) 
```

For the most part, median interest rates remain consistent across the various states in the US. The highest deviation from the median is at most 3%, with most states deviating by less than 1%. States with the highest deviations also have the lowest samples on average amongst the states. 

### The Power of Credit Score and Rating on Interest Rates

```{r, echo=FALSE, warning=FALSE, CreditScore_BorrowerRate_Rating_final, fig.height=5, fig.width=10}
ggplot(data = subset(loans, ratings != 'NC' & !is.na(ratings)), 
       aes(x = CreditScoreAverage, y = BorrowerRate, color = ratings)) +
  geom_point(alpha = 0.5,
             position = position_jitter(w = 9)) +
  scale_x_continuous(limits = c(400, 900),
                     breaks = c(seq(400, 900, 50))) + 
  scale_color_brewer(palette = "RdBu") + 
  lims(y = c(0, 0.4)) +
  labs(x = "Credit Score", 
       y = "Interest Rate (%)",
       color = "Ratings",
       title = "Interest Rate vs. Credit Score by Rating") +
  theme(panel.background = element_rect(fill = '#AAAAAA'),
        panel.grid.major = element_line(color = '#878787'),
        panel.grid.minor = element_line(color = '#878787')) 
```

As credit score increases, interest rates fall. The bands of diverging colors show the change in rating as you get higher credit scores. The safest investments appear at the highest credit scores with low interest rates and the best ratings. The high risk investments usually have low credit scores, high interest rates, and low ratings. 

## Reflection

Overall, this was a very interesting and enlightening dataset to explore. It was really surprising to me how impactful credit score was on interest rate, and how negligible income, locale, and employment were. Perhaps some of those other variables are used to determing whether a borrower can get a loan to begin with rather than what there interest rate will be.

The hardest part of this project was sifting through the vast amount of variables. There are so many potential combinations of categorical and continuous variables that I might have missed some interesting trends. I sometimes found myself at a dead end in the later bi/multivariate sections, wishing that I could go back and add more variables without increasing the bulk of the project. I think in the future I will use more visualization tools to preview as much of the data as possible first before diving into analyzing multiple variables at once. That way, I can sift through the variables that have no trends and go straight to the more impactful relationships.

I definitely believe that more research can be done on this dataset. There are variables that I didn't explore due to the length of the project and the depth of the dataset. I would love to one day revisit this project and perfect the model further by implementing more features. I could also take a deep dive in investing the the unusual high occurence of the 32% interest rate. In the end, I learned a lot about EDA in this project and now have a whole toolkit of methods at my disposal to explore other datasets.





